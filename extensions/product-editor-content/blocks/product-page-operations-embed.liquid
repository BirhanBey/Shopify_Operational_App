{%- comment -%}
  App Embed: Product Page Operations
  Injects config and loads product page script
{%- endcomment -%}

<script>
  // Build variant metafields map from liquid
  const variantMetafieldsMap = {};
  {% if product.variants %}
    {% for variant in product.variants %}
      {% assign useProjectRefMetafield = variant.metafields.custom.use_project_reference %}
      {% assign templateIdMetafield = variant.metafields.custom.template_id %}
      {% assign materialIdMetafield = variant.metafields.custom.material_id %}
      {% assign useProjectRef = false %}
      {% if useProjectRefMetafield %}
        {% assign metafield_value = useProjectRefMetafield.value %}
        {% if metafield_value == "true" or metafield_value == true %}
          {% assign useProjectRef = true %}
        {% endif %}
      {% endif %}
      {% assign templateId = templateIdMetafield.value | default: null %}
      {% assign materialId = materialIdMetafield.value | default: null %}
      variantMetafieldsMap['{{ variant.id }}'] = { 
        useProjectReference: {{ useProjectRef }}, 
        templateId: {% if templateId %}'{{ templateId }}'{% else %}null{% endif %},
        materialId: {% if materialId %}'{{ materialId }}'{% else %}null{% endif %}
      };
      variantMetafieldsMap['gid://shopify/ProductVariant/{{ variant.id }}'] = { 
        useProjectReference: {{ useProjectRef }}, 
        templateId: {% if templateId %}'{{ templateId }}'{% else %}null{% endif %},
        materialId: {% if materialId %}'{{ materialId }}'{% else %}null{% endif %}
      };
    {% endfor %}
  {% endif %}

  window.__EDITOR_PRODUCT_CONFIG__ = Object.assign(
    {},
    window.__EDITOR_PRODUCT_CONFIG__,
    {
      appUrl: '{{ block.settings.app_url | escape }}',
      shop: '{{ shop.permanent_domain }}',
      variantMetafields: variantMetafieldsMap,
    },
  );
  window.__EDITOR_PRODUCT_OPERATIONS_ACTIVE = true;
</script>
<script src="{{ 'product-page-operations.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Product Ops Embed",
  "target": "body",
  "settings": [
    {
      "type": "text",
      "id": "app_url",
      "label": "App URL",
      "info": "Your app backend URL (e.g., https://your-app.ngrok.io)"
    }
  ]
}
{% endschema %}

