{%- comment -%}
  App Embed: Product Page Operations
  Injects config and loads product page script
{%- endcomment -%}

<style>
  /* Disable fly-to-cart animation */
  fly-to-cart {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
  }
</style>

<script>
  // Build variant metafields map from liquid
  const variantMetafieldsMap = {};
  {% if product.variants %}
    {% for variant in product.variants %}
      {% assign use_project_ref_metafield = variant.metafields.custom.use_project_reference %}
      {% assign template_id_metafield = variant.metafields.custom.template_id %}
      {% assign material_id_metafield = variant.metafields.custom.material_id %}
      {% assign use_image_uploads_metafield = variant.metafields.custom.use_image_uploads %}
      {% assign editor_type_metafield = variant.metafields.custom.editor_type %}
      {% assign use_project_ref = false %}
      {% if use_project_ref_metafield %}
        {% assign metafield_value = use_project_ref_metafield.value %}
        {% if metafield_value == "true" or metafield_value == true %}
          {% assign use_project_ref = true %}
        {% endif %}
      {% endif %}
      {% assign use_image_uploads = false %}
      {% if use_image_uploads_metafield %}
        {% assign uploads_value = use_image_uploads_metafield.value %}
        {% if uploads_value == "true" or uploads_value == true %}
          {% assign use_image_uploads = true %}
        {% endif %}
      {% endif %}
      {% assign template_id = template_id_metafield.value | default: null %}
      {% assign material_id = material_id_metafield.value | default: null %}
      {% assign editor_type = null %}
      {% if editor_type_metafield and editor_type_metafield.value %}
        {% assign editor_type = editor_type_metafield.value | first | default: null %}
      {% endif %}
      variantMetafieldsMap['{{ variant.id }}'] = { 
        useProjectReference: {{ use_project_ref }}, 
        templateId: {% if template_id %}'{{ template_id }}'{% else %}null{% endif %},
        materialId: {% if material_id %}'{{ material_id }}'{% else %}null{% endif %},
        useImageUploads: {{ use_image_uploads }},
        editorType: {% if editor_type %}'{{ editor_type }}'{% else %}null{% endif %}
      };
      variantMetafieldsMap['gid://shopify/ProductVariant/{{ variant.id }}'] = { 
        useProjectReference: {{ use_project_ref }}, 
        templateId: {% if template_id %}'{{ template_id }}'{% else %}null{% endif %},
        materialId: {% if material_id %}'{{ material_id }}'{% else %}null{% endif %},
        useImageUploads: {{ use_image_uploads }},
        editorType: {% if editor_type %}'{{ editor_type }}'{% else %}null{% endif %}
      };
    {% endfor %}
  {% endif %}

  window.__EDITOR_PRODUCT_CONFIG__ = Object.assign(
    {},
    window.__EDITOR_PRODUCT_CONFIG__,
    {
      appUrl: '{{ block.settings.app_url | escape }}',
      shop: '{{ shop.permanent_domain }}',
      variantMetafields: variantMetafieldsMap,
    },
  );
  window.__EDITOR_PRODUCT_OPERATIONS_ACTIVE = true;

  // Disable fly-to-cart animation
  (function() {
    // Remove existing fly-to-cart elements
    function removeFlyToCart() {
      const flyToCartElements = document.querySelectorAll('fly-to-cart');
      flyToCartElements.forEach(el => el.remove());
    }

    // Remove immediately if DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', removeFlyToCart);
    } else {
      removeFlyToCart();
    }

    // Use MutationObserver to remove fly-to-cart elements as they are added
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        mutation.addedNodes.forEach(function(node) {
          if (node.nodeType === 1) { // Element node
            if (node.tagName === 'FLY-TO-CART') {
              node.remove();
            }
            // Also check for fly-to-cart elements within added nodes
            const flyToCartElements = node.querySelectorAll && node.querySelectorAll('fly-to-cart');
            if (flyToCartElements) {
              flyToCartElements.forEach(el => el.remove());
            }
          }
        });
      });
    });

    // Start observing when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        observer.observe(document.body, {
          childList: true,
          subtree: true
        });
      });
    } else {
      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
    }
  })();
</script>
<script src="{{ 'product-page-operations.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Product Ops Embed",
  "target": "body",
  "settings": [
    {
      "type": "text",
      "id": "app_url",
      "label": "App URL",
      "info": "Your app backend URL (e.g., https://your-app.ngrok.io)"
    }
  ]
}
{% endschema %}

